# Таблица "Нарушения ПДД", запросы корректировки

В этом уроке на каждом шаге используется таблица, в которой представлена информация о начисленных водителям штрафах за нарушения правил дорожного движения (ПДД). 
С помощью запросов корректировки необходимо выполнить следующие действия:

- [создать таблицу с информацией о штрафах]();
- [заполнить ее]();
- [занести сумму штрафа за каждое новое нарушение ПДД]();
- [если водитель на определенной машине совершил повторное нарушение, то сумму его штрафа за данное нарушение нужно увеличить в два раза (часть 1, часть 2)]();
- [если водитель оплатил свой штраф в течение 20 дней со дня нарушения, то значение его штрафа уменьшить в два раза]();
- [создать новую таблицу,  в которую включить информацию о всех неоплаченных штрафах]();
- [удалить информацию о нарушениях, совершенных раньше некоторой даты]().

На четвертом шаге рассматривается временное именование таблиц (алиасы). 

## Структура и наполнение таблиц

В таблице `fine` представлена информация о начисленных водителям штрафах за нарушения правил дорожного движения (ПДД) (фамилия водителя, номер машины, описание нарушения, сумма штрафа, дата совершения нарушения и дата оплаты штрафа):

|fine_id|name|number_plate|violation|sum_fine|date_violation|date_payment|
|:-- |:-- |:-- |:-- |:-- |:-- |:-- |
|__INT PRIMARY KEY AUTO_INCREMENT__|__VARCHAR(30)__|__VARCHAR(6)__|__VARCHAR(50)__|__DECIMAL(8,2)__|__DATЕ__|__DATE__|
|1|Баранов П.Е.|Р523ВТ|Превышение скорости (от 40 до 60)|500.00|2020-01-12|2020-01-17|
|2|Абрамова К.А.|О111АВ|Проезд на запрещающий сигнал|1000.00|2020-01-14|2020-02-27|
|3|Яковлев Г.Р.|Т330ТТ|Превышение скорости (от 20 до 40)|500.00|2020-01-23|2020-02-23|
|4|Яковлев Г.Р.|М701АА|Превышение скорости (от 20 до 40)||2020-01-12||
|5|Колесов С.П.|К892АХ|Превышение скорости (от 20 до 40)||2020-02-01||
|6|Баранов П.Е.|Р523ВТ|Превышение скорости (от 40 до 60)||2020-02-14||
|7|Абрамова К.А.|О111АВ|Проезд на запрещающий сигнал||2020-02-23||
|8|Яковлев Г.Р.|Т330ТТ|Проезд на запрещающий сигнал||2020-03-03||


В таблицу  `traffic_violation` занесены нарушения ПДД и соответствующие штрафы (в рублях): 

|violation_id|violation|sum_fine|
|:-- |:-- |:-- |
|INT PRIMARY KEY AUTO_INCREMENT|VARCHAR(50)|DECIMAL(8,2)|
|1|Превышение скорости (от 20 до 40)|500.00|
|2|Превышение скорости (от 40 до 60)|1000.00|
|3|Проезд на запрещающий сигнал|1000.00|


## Создание таблицы с информацией о штрафах

Создать таблицу `fine` следующей структуры:

|Поле|Описание|
|:-- |:-- |
|fine_id|ключевой столбец целого типа с автоматическим увеличением значения ключа на 1|
|name|строка длиной 30|
|number_plate|строка длиной 6|
|violation|строка длиной 50|
|sum_fine|вещественное число, максимальная длина 8, количество знаков после запятой 2|
|date_violation|дата|
|date_payment|дата|

<hr>

```sql
CREATE TABLE fine (
    fine_id INT PRIMARY KEY AUTO_INCREMENT,
    name VARCHAR(30),
    number_plate VARCHAR(6),
    violation VARCHAR(50),
    sum_fine DECIMAL(8,2),
    date_violation DATE,
    date_payment DATE
);
```
```sql
Query result:
Affected rows: 0
```
<hr>

[:arrow_up:Наверх](#таблица-нарушения-пдд-запросы-корректировки)

## заполнить ее

<hr>

```sql
INSERT INTO fine (fine_id, name, number_plate, violation, date_violation)
VALUES 
    (6, 'Баранов П.Е.', 'Р523ВТ', 'Превышение скорости(от 40 до 60)', '2020-02-14'),
    (7, 'Абрамова К.А.', 'О111АВ', 'Проезд на запрещающий сигнал', '2020-02-23'),
    (8, 'Яковлев Г.Р.', 'Т330ТТ', 'Проезд на запрещающий сигнал', '2020-03-03');

```
```sql
Query result:
Affected rows: 3
```
<hr>

[:arrow_up:Наверх](#таблица-нарушения-пдд-запросы-корректировки)

## занести сумму штрафа за каждое новое нарушение ПДД

Занести в таблицу `fine` суммы штрафов, которые должен оплатить водитель, в соответствии с данными из таблицы `traffic_violation`.
При этом суммы заносить только в пустые поля столбца  `sum_fine`.

Таблица `traffic_violation` создана и заполнена.

Важно! Сравнение значения столбца с пустым значением осуществляется с помощью оператора `IS NULL`.

<hr>

```sql
UPDATE fine AS f, traffic_violation AS tv
SET f.sum_fine = tv.sum_fine
WHERE f.violation = tv.violation AND f.sum_fine IS NULL;

SELECT * FROM fine;
```
```sql
Query result:
+---------+---------------+--------------+----------------------------------+----------+----------------+--------------+
| fine_id | name          | number_plate | violation                        | sum_fine | date_violation | date_payment |
+---------+---------------+--------------+----------------------------------+----------+----------------+--------------+
| 1       | Баранов П.Е.  | Р523ВТ       | Превышение скорости(от 40 до 60) | 500.00   | 2020-01-12     | 2020-01-17   |
| 2       | Абрамова К.А. | О111АВ       | Проезд на запрещающий сигнал     | 1000.00  | 2020-01-14     | 2020-02-27   |
| 3       | Яковлев Г.Р.  | Т330ТТ       | Превышение скорости(от 20 до 40) | 500.00   | 2020-01-23     | 2020-02-23   |
| 4       | Яковлев Г.Р.  | М701АА       | Превышение скорости(от 20 до 40) | 500.00   | 2020-01-12     | NULL         |
| 5       | Колесов С.П.  | К892АХ       | Превышение скорости(от 20 до 40) | 500.00   | 2020-02-01     | NULL         |
| 6       | Баранов П.Е.  | Р523ВТ       | Превышение скорости(от 40 до 60) | 1000.00  | 2020-02-14     | NULL         |
| 7       | Абрамова К.А. | О111АВ       | Проезд на запрещающий сигнал     | 1000.00  | 2020-02-23     | NULL         |
| 8       | Яковлев Г.Р.  | Т330ТТ       | Проезд на запрещающий сигнал     | 1000.00  | 2020-03-03     | NULL         |
+---------+---------------+--------------+----------------------------------+----------+----------------+--------------+
```
<hr>

[:arrow_up:Наверх](#таблица-нарушения-пдд-запросы-корректировки)

## Вывести фамилию, номер машины и нарушение только для тех водителей, которые на одной машине нарушили одно и то же правило два и более раз. 

Вывести фамилию, номер машины и нарушение только для тех водителей, которые на одной машине нарушили одно и то же правило   два и более раз. При этом учитывать все нарушения, независимо от того оплачены они или нет. Информацию отсортировать в алфавитном порядке, сначала по фамилии водителя, потом по номеру машины и, наконец, по нарушению.

<hr>

```sql
SELECT name, number_plate, violation
FROM fine
GROUP BY name, number_plate, violation
HAVING ABS(count(number_plate)) >= 2
ORDER BY name, number_plate, violation;
```
```sql
Query result:
+---------------+--------------+----------------------------------+
| name          | number_plate | violation                        |
+---------------+--------------+----------------------------------+
| Абрамова К.А. | О111АВ       | Проезд на запрещающий сигнал     |
| Баранов П.Е.  | Р523ВТ       | Превышение скорости(от 40 до 60) |
+---------------+--------------+----------------------------------+
```
<hr>

[:arrow_up:Наверх](#таблица-нарушения-пдд-запросы-корректировки)

## если водитель на определенной машине совершил повторное нарушение, то сумму его штрафа за данное нарушение нужно увеличить в два раза (часть 1, часть 2)

В таблице `fine` увеличить в два раза сумму неоплаченных штрафов для отобранных на предыдущем шаге записей. 


<hr>

```sql
UPDATE fine f, (
    SELECT name, number_plate, violation FROM fine
    GROUP BY name, number_plate, violation
    HAVING ABS(count(number_plate)) >= 2
) query_in
SET f.sum_fine = 2 * f.sum_fine
WHERE f.date_payment IS NULL
    AND f.name = query_in.name
    AND f.number_plate = query_in.number_plate
    AND f.violation = query_in.violation;

SELECT * FROM fine;
```
```sql
Query result:
+---------+---------------+--------------+----------------------------------+----------+----------------+--------------+
| fine_id | name          | number_plate | violation                        | sum_fine | date_violation | date_payment |
+---------+---------------+--------------+----------------------------------+----------+----------------+--------------+
| 1       | Баранов П.Е.  | Р523ВТ       | Превышение скорости(от 40 до 60) | 500.00   | 2020-01-12     | 2020-01-17   |
| 2       | Абрамова К.А. | О111АВ       | Проезд на запрещающий сигнал     | 1000.00  | 2020-01-14     | 2020-02-27   |
| 3       | Яковлев Г.Р.  | Т330ТТ       | Превышение скорости(от 20 до 40) | 500.00   | 2020-01-23     | 2020-02-23   |
| 4       | Яковлев Г.Р.  | М701АА       | Превышение скорости(от 20 до 40) | 500.00   | 2020-01-12     | NULL         |
| 5       | Колесов С.П.  | К892АХ       | Превышение скорости(от 20 до 40) | 500.00   | 2020-02-01     | NULL         |
| 6       | Баранов П.Е.  | Р523ВТ       | Превышение скорости(от 40 до 60) | 2000.00  | 2020-02-14     | NULL         |
| 7       | Абрамова К.А. | О111АВ       | Проезд на запрещающий сигнал     | 2000.00  | 2020-02-23     | NULL         |
| 8       | Яковлев Г.Р.  | Т330ТТ       | Проезд на запрещающий сигнал     | 1000.00  | 2020-03-03     | NULL         |
+---------+---------------+--------------+----------------------------------+----------+----------------+--------------+
```
<hr>

[:arrow_up:Наверх](#таблица-нарушения-пдд-запросы-корректировки)

## если водитель оплатил свой штраф в течение 20 дней со дня нарушения, то значение его штрафа уменьшить в два раза

Водители оплачивают свои штрафы. В таблице `payment` занесены даты их оплаты:

|payment_id|name|number_plate|violation|date_violation|date_payment|
|:--- |:--- |:--- |:--- |:--- |:--- |
|1|Яковлев Г.Р.|М701АА|Превышение скорости(от 20 до 40)|2020-01-12|2020-01-22|
|2|Баранов П.Е.|Р523ВТ|Превышение скорости(от 40 до 60)|2020-02-14|2020-03-06|
|3|Яковлев Г.Р.|Т330ТТ|Проезд на запрещающий сигнал|2020-03-03|2020-03-23|

__Необходимо:__

- в таблицу `fine` занести дату оплаты соответствующего штрафа из таблицы `payment`; 
- уменьшить начисленный штраф в таблице fine в два раза  (только для тех штрафов, информация о которых занесена в таблицу `payment`) , если оплата произведена не позднее 20 дней со дня нарушения.

<hr>

```sql
UPDATE fine f, payment pt
SET f.date_payment = pt.date_payment,
    f.sum_fine = IF (DATEDIFF(pt.date_payment, pt.date_violation) <= 20, f.sum_fine / 2, f.sum_fine)
WHERE f.name = pt.name
    AND f.number_plate = pt.number_plate
    AND f.violation = pt.violation
    AND f.date_payment IS NULL;

SELECT * FROM fine;
```
```sql
Query result:
+---------+---------------+--------------+----------------------------------+----------+----------------+--------------+
| fine_id | name          | number_plate | violation                        | sum_fine | date_violation | date_payment |
+---------+---------------+--------------+----------------------------------+----------+----------------+--------------+
| 1       | Баранов П.Е.  | Р523ВТ       | Превышение скорости(от 40 до 60) | 500.00   | 2020-01-12     | 2020-01-17   |
| 2       | Абрамова К.А. | О111АВ       | Проезд на запрещающий сигнал     | 1000.00  | 2020-01-14     | 2020-02-27   |
| 3       | Яковлев Г.Р.  | Т330ТТ       | Превышение скорости(от 20 до 40) | 500.00   | 2020-01-23     | 2020-02-23   |
| 4       | Яковлев Г.Р.  | М701АА       | Превышение скорости(от 20 до 40) | 250.00   | 2020-01-12     | 2020-01-22   |
| 5       | Колесов С.П.  | К892АХ       | Превышение скорости(от 20 до 40) | 500.00   | 2020-02-01     | NULL         |
| 6       | Баранов П.Е.  | Р523ВТ       | Превышение скорости(от 40 до 60) | 2000.00  | 2020-02-14     | 2020-03-06   |
| 7       | Абрамова К.А. | О111АВ       | Проезд на запрещающий сигнал     | 2000.00  | 2020-02-23     | NULL         |
| 8       | Яковлев Г.Р.  | Т330ТТ       | Проезд на запрещающий сигнал     | 500.00   | 2020-03-03     | 2020-03-23   |
+---------+---------------+--------------+----------------------------------+----------+----------------+--------------+
```
<hr>

[:arrow_up:Наверх](#таблица-нарушения-пдд-запросы-корректировки)

## создать новую таблицу,  в которую включить информацию о всех неоплаченных штрафах

Создать новую таблицу back_payment, куда внести информацию о неоплаченных штрафах (Фамилию и инициалы водителя, номер машины, нарушение, сумму штрафа  и  дату нарушения) из таблицы fine.

<hr>

```sql
CREATE TABLE back_payment AS
SELECT name, number_plate, violation, sum_fine, date_violation FROM fine
WHERE date_payment IS NULL;

SELECT * FROM back_payment;
```
```sql
Query result:
+---------------+--------------+----------------------------------+----------+----------------+
| name          | number_plate | violation                        | sum_fine | date_violation |
+---------------+--------------+----------------------------------+----------+----------------+
| Колесов С.П.  | К892АХ       | Превышение скорости(от 20 до 40) | 500.00   | 2020-02-01     |
| Абрамова К.А. | О111АВ       | Проезд на запрещающий сигнал     | 2000.00  | 2020-02-23     |
+---------------+--------------+----------------------------------+----------+----------------+
```
<hr>

[:arrow_up:Наверх](#таблица-нарушения-пдд-запросы-корректировки)

## удалить  информацию о нарушениях, совершенных раньше некоторой даты

Удалить из таблицы fine информацию о нарушениях, совершенных раньше 1 февраля 2020 года. 

<hr>

```sql
DELETE FROM fine
WHERE date_violation < '2020-02-01';

SELECT * FROM fine
```
```sql
Query result:
+---------+---------------+--------------+----------------------------------+----------+----------------+--------------+
| fine_id | name          | number_plate | violation                        | sum_fine | date_violation | date_payment |
+---------+---------------+--------------+----------------------------------+----------+----------------+--------------+
| 5       | Колесов С.П.  | К892АХ       | Превышение скорости(от 20 до 40) | 500.00   | 2020-02-01     | NULL         |
| 6       | Баранов П.Е.  | Р523ВТ       | Превышение скорости(от 40 до 60) | 2000.00  | 2020-02-14     | 2020-03-05   |
| 7       | Абрамова К.А. | О111АВ       | Проезд на запрещающий сигнал     | 2000.00  | 2020-02-23     | NULL         |
| 8       | Яковлев Г.Р.  | Т330ТТ       | Проезд на запрещающий сигнал     | 500.00   | 2020-03-03     | 2020-03-22   |
+---------+---------------+--------------+----------------------------------+----------+----------------+--------------+
```
<hr>

[:arrow_up:Наверх](#таблица-нарушения-пдд-запросы-корректировки)
